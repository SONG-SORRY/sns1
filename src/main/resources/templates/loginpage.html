<html layout:decorate="~{loginpage_layout}">
    <div layout:fragment="content" class="login-box">
        <form th:action="@{/user/login}" method="post" onsubmit="return login(event)">
            <div class="logo">My SNS</div>
            <div class="login-mark">로그인</div>

            <div id="error-box" class="error-container" 
                 th:style="${param.error} ? 'display:block' : 'display:none'">
                
                <div id="error-msg" class="error-msg">
                    <span th:if="${param.error}">이메일 또는 비밀번호가 일치하지 않습니다.</span>
                </div>
            </div>

            <input type="text" name="username" id="username" placeholder="이메일">
            <input type="password" name="password" id="password" placeholder="비밀번호">
                
            <button href="/" type="submit" class="btn-submit">로그인</button>
            <a href="/user/signup" class="login-footer">가입하기</a>
        </form>

        <script>
            async function login(event) {
                event.preventDefault();

                const email = document.getElementById("username");
                const pass = document.getElementById("password");
                const errorBox = document.getElementById("error-box");
                const errorMsg = document.getElementById("error-msg");

                if (email.value.trim() === "") {
                    showError("이메일을 입력해 주세요.");
                    email.focus();
                    return;
                }
                if (pass.value.trim() === "") {
                    showError("비밀번호를 입력해 주세요.");
                    pass.focus();
                    return;
                }

                const formData = new FormData();
                formData.append("username", email.value);
                formData.append("password", pass.value);

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";
                
                try {
                    const response = await fetch("/user/login", {
                        method: "POST",
                        headers: { [header]: token }, 
                        body: formData
                    });

                    if (response.ok || response.status === 401) {
                        const data = await response.json();
                        
                        if (data.status === "success") {
                            window.location.replace("/");
                        } else {
                            showError(data.message);
                        }
                    } else {
                        showError("서버 오류가 발생했습니다.");
                    }
                } catch (e) {
                    console.error(e);
                    showError("시스템 오류입니다.");
                }
            }

            function showError(msg) {
                const errorBox = document.getElementById("error-box");
                const errorMsg = document.getElementById("error-msg");
                errorBox.style.display = "block";
                errorMsg.innerText = msg;
            }
        </script>
    </div>
</html>

