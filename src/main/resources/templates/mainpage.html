<html layout:decorate="~{mainpage_layout}">
    <div layout:fragment="content" class="container">
        <div class="write-box">
            <form onsubmit="return submitPost(event)">
                <textarea id="write-input" class="write-input" placeholder="무슨 생각을 하고 계신가요?"></textarea>
                <input type="file" id="file" name="file" style="display: none;" onchange="updateFileName()">
                <div id="fileNameDisplay" style="font-size: 12px; color: #1877f2; margin-bottom: 5px;"></div>
                <div class="horizontal-line"></div>
                
                <div class="write-footer">
                    <button type="button" class="btn-gray" onclick="document.getElementById('file').click()">추가</button>
                    <button type="submit" class="btn-blue">게시</button>
                </div>
            </form>
        </div>

        <div class="post-answer-box" th:each="post : ${postList}" th:id="'post-answer-box-' + ${post.id}">
            <div class="post-left">
                <div class="post-header">
                    <div class="username-display"
                        th:data-user-id="${post.author != null ? post.author.id : ''}"
                        th:text="${post.author != null ? post.author.username : '탈퇴한 사용자'}"
                        th:style="${post.author != null ? 'font-weight: bold; color: #050505;' : 'font-weight: bold; color: #999;'}">
                    </div>
                    <div>
                        <span th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}"></span>
                        <span th:if="${post.deletedAt != null}" style="color: #999; font-size: 13px;"> (삭제됨)</span>
                        <span th:if="${post.deletedAt == null and post.modifiedAt != null}" style="color: #999; font-size: 13px;"> (수정됨)</span>
                    </div>
                </div> 
                <div class="post-box">
                    <div th:text="${post.deletedAt != null ? '삭제된 게시물입니다.' : post.content}" 
                        th:style="${post.deletedAt != null ? 'white-space: pre-wrap; color: #999;' : 'white-space: pre-wrap;'}">
                    </div>
                    <div th:if="${post.imgUrl != null and post.deletedAt == null}" style="display: flex; justify-content: center;">
                        <img th:src="${post.imgUrl}" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 30px; margin-top: 20px;">
                    </div>
                </div>
                <div th:if="${post.author != null and #authentication.principal.id == post.author.id}"
                    style="margin-top: auto; display: flex; justify-content: flex-end; padding-top: 10px;">
                    <button type="button"
                            th:onclick="'modifyPost(' + ${post.id} + ')'"
                            style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                            수정</button>
                    <div class="post-vertical-line"></div>
                    <button type="button"
                            th:onclick="'deletePost(' + ${post.id} + ')'"
                            style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                            삭제</button>
                </div>
            </div>

            <div class="post-right">
                <div class="answer-box">
                    <div class="answer-content-box" th:each="answer : ${post.answerList}" th:id="'answer-' + ${answer.id}">
                        <div class="post-header">
                            <div class="username-display"
                                th:data-user-id="${answer.author != null ? answer.author.id : ''}"
                                th:text="${answer.author != null ? answer.author.username : '탈퇴한 사용자'}"
                                th:style="${answer.author != null ? 'font-weight: bold; color: #050505;' : 'font-weight: bold; color: #999;'}">
                            </div>
                            <div>
                                <span th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></span>
                                <span th:if="${answer.deletedAt != null}" style="color: #999; font-size: 13px;"> (삭제됨)</span>
                                <span th:if="${answer.deletedAt == null and answer.modifiedAt != null}" style="color: #999; font-size: 13px;"> (수정됨)</span>
                            </div>
                        </div>
                        <div th:text="${answer.deletedAt != null ? '삭제된 댓글입니다.' : answer.content}" 
                            th:style="${answer.deletedAt != null ? 'color: #999; white-space: pre-wrap;' : 'white-space: pre-wrap;'}">
                        </div>
                        <div th:if="${answer.author != null and #authentication.principal.id == answer.author.id}"
                            style="margin-top: auto; display: flex; justify-content: flex-end; padding-top: 10px;">
                            <button type="button"
                                    th:onclick="'modifyAnswer(' + ${answer.id} + ')'"
                                    style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                                    수정</button>
                            <div class="answer-vertical-line"></div>
                            <button type="button"
                                    th:onclick="'deleteAnswer(' + ${answer.id} + ')'"
                                    style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                                    삭제</button>
                        </div>
                        <div th:id="'modifyAnswer-' + ${answer.id}" class="modal-overlay">
                            <div class="modal-box">
                                <div class="modal-header">댓글 수정</div>
                                
                                <textarea th:id="'modify-answer-content-' + ${answer.id}" 
                                        class="modify-content-input" 
                                        placeholder="내용을 입력해 주세요."></textarea>

                                <div class="modal-footer">
                                    <div></div> <div style="gap: 10px;">
                                        <button type="button" class="btn-gray" th:onclick="'closeModifyAnswerModal(' + ${answer.id} + ')'">취소</button>
                                        <button type="button" class="btn-blue" th:onclick="'submitModifyAnswer(' + ${answer.id} + ')'">수정 완료</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="horizontal-line"></div>
                <form th:onsubmit="'return submitAnswer(this, event, ' + ${post.id} + ')'">
                    <div class="answer-footer">
                        <textarea class="answer-input-box answer-input" placeholder="댓글을 작성해 주세요."></textarea>
                        <button type="submit" class="btn-blue">게시</button>
                    </div>
                </form>
            </div>
            <div th:id="'modifyPost-' + ${post.id}" class="modal-overlay">
                <div class="modal-box">
                    <div class="modal-header">게시물 수정</div>
                    
                    <textarea th:id="'modify-content-input-' + ${post.id}" class="modify-content-input" placeholder="내용을 입력해 주세요."></textarea>

                    <div th:id="'modify-image-container-' + ${post.id}" style="position: relative; display: none; margin-top: 10px;">
                        <img th:id="'modify-image-preview-' + ${post.id}" src="" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 30px;">
                        <button type="button" 
                                th:onclick="'removeImageInModal(' + ${post.id} + ')'"
                                class="x-button">X
                        </button>
                    </div>
                    <input type="checkbox" th:id="'delete-img-check-' + ${post.id}" style="display: none;">
                    
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <span th:id="'modify-filename-' + ${post.id}" style="font-size: 13px; color: #1877f2;"></span>
                        <input type="file" th:id="'modify-file-' + ${post.id}" style="display: none;" th:onchange="'updateModifyFile(' + ${post.id} + ')'">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-gray" th:onclick="'document.getElementById(\'modify-file-' + ${post.id} + '\').click()'">추가</button>
                        <div style="gap: 10px;">
                            <button type="button" class="btn-gray" th:onclick="'closeModifyPostModal(' + ${post.id} + ')'">취소</button>
                            <button type="button" class="btn-blue" th:onclick="'submitModifyPost(' + ${post.id} + ')'">수정 완료</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <script> 
            // 게시물 댓글 스크롤을 최하단으로 이동.
            document.addEventListener("DOMContentLoaded", function() {
                const answerBoxes = document.querySelectorAll('.answer-box');
                answerBoxes.forEach(function(box) {
                    box.scrollTop = box.scrollHeight;
                });
            });
            // 댓글 입력 중 댓글 입력창 높이에 의한 댓글창 가림 해결.
            document.addEventListener("input", function(e) {
                if (e.target.tagName.toLowerCase() === "textarea" && e.target.classList.contains("answer-input")) {
                    
                    const textarea = e.target;
                    const form = textarea.closest('form');
                    const postBox = form.closest('.post-right');
                    const answerContainer = postBox.querySelector('.answer-box');

                    if (!textarea.dataset.prevHeight) {
                        textarea.dataset.prevHeight = textarea.clientHeight;
                    }

                    const isAtBottom = answerContainer.scrollHeight - answerContainer.scrollTop - answerContainer.clientHeight < 10;

                    const currentHeight = textarea.clientHeight;
                    const prevHeight = parseFloat(textarea.dataset.prevHeight);
                    const diff = currentHeight - prevHeight;

                    if (isAtBottom) {
                        answerContainer.scrollTop = answerContainer.scrollHeight;
                    } else {
                        if (diff !== 0) {
                            answerContainer.scrollTop += diff;
                        }
                    }

                    textarea.dataset.prevHeight = currentHeight;
                        }
                    });

                    document.addEventListener("focusin", function(e) {
                        if (e.target.tagName.toLowerCase() === "textarea" && e.target.classList.contains("answer-input")) {
                            e.target.dataset.prevHeight = e.target.clientHeight;
                        }
                    });

            // 선택된 파일명을 화면에 보여주는 기능.
            function updateFileName() {
                const fileInput = document.getElementById('file');
                const fileNameDisplay = document.getElementById('fileNameDisplay');
                
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                } else {
                    fileNameDisplay.textContent = "";
                }
            }

            // AJAX 게시물 등록.
            async function submitPost(event) {
                event.preventDefault(); 


                const contentInput = document.getElementById('write-input');
                const fileInput = document.getElementById('file');
                

                const content = contentInput.value;
                const file = fileInput.files[0];

                if (content.trim() === "" && !file) {
                    alert("내용을 입력해 주세요.");
                    return false;
                }

                const formData = new FormData();
                formData.append("content", content);
                if (file) {
                    formData.append("file", file);
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch("/post/create", { 
                        method: "POST",
                        headers: {
                            [header]: token 
                        },
                        body: formData
                    });

                    if (response.ok) {
                        contentInput.value = "";
                        fileInput.value = "";
                        document.getElementById('fileNameDisplay').textContent = "";
                    } else {
                        const data = await response.json();
                        alert(data.message);
                    }
                } catch (error) {
                    console.error(error);
                    alert("에러 발생");
                }
                return false;
            }

            // AJAX 게시물 수정.
            function updateModifyFile(postId) {
                const fileInput = document.getElementById('modify-file-' + postId);
                const fileNameDisplay = document.getElementById('modify-filename-' + postId);
                const previewContainer = document.getElementById('modify-image-container-' + postId);
                const previewImg = document.getElementById('modify-image-preview-' + postId);
                const deleteCheck = document.getElementById('delete-img-check-' + postId);
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                    deleteCheck.checked = false;
                } else {
                    fileNameDisplay.textContent = "";
                }
            }

            function modifyPost(postId) {
                const postAnswerBox = document.getElementById('post-answer-box-' + postId);
                const contentDiv = postAnswerBox.querySelector('.post-box > div:first-child');
                const oldContent = contentDiv.innerText;

                if (oldContent === "삭제된 게시물입니다.") {
                alert("삭제된 게시물입니다.");
                return;
                }

                document.getElementById('modify-content-input-' + postId).value = oldContent;
                document.getElementById('modify-file-' + postId).value = "";
                document.getElementById('modify-filename-' + postId).textContent = "";
                document.getElementById('delete-img-check-' + postId).checked = false;

                const existingImgTag = postAnswerBox.querySelector('.post-box img');
                const previewContainer = document.getElementById('modify-image-container-' + postId);
                const previewImg = document.getElementById('modify-image-preview-' + postId);

                if (existingImgTag) {
                    previewImg.src = existingImgTag.src;
                    previewContainer.style.display = 'block';
                } else {
                    previewContainer.style.display = 'none';
                    previewImg.src = "";
                }
                
                const modal = document.getElementById('modifyPost-' + postId).style.display = 'flex';
            }

            function removeImageInModal(postId) {
                document.getElementById('modify-image-container-' + postId).style.display = 'none';
                document.getElementById('modify-file-' + postId).value = "";
                document.getElementById('modify-filename-' + postId).textContent = "";
                document.getElementById('delete-img-check-' + postId).checked = true;
            }

            function closeModifyPostModal(postId) {
                document.getElementById('modifyPost-' + postId).style.display = 'none';
            }

            async function submitModifyPost(postId) {
                const contentInput = document.getElementById('modify-content-input-' + postId);
                const fileInput = document.getElementById('modify-file-' + postId);
                const deleteCheck = document.getElementById('delete-img-check-' + postId);

                const imageContainer = document.getElementById('modify-image-container-' + postId);
                const isImageVisible = imageContainer.style.display !== 'none';

                const isDeleteChecked = deleteCheck.checked;
                const newContent = contentInput.value;
                const newFile = fileInput.files[0];

                if (newContent.trim() === "" && !isImageVisible) {
                    alert("내용을 입력해 주세요.");
                    return;
                }

                const formData = new FormData();
                formData.append("newContent", newContent);
                if (newFile) {
                    formData.append("newFile", newFile);
                }
                formData.append("deleteImg", isDeleteChecked);
                
                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/post/modify/${postId}`, {
                        method: "POST",
                        headers: { [header]: token },
                        body: formData
                    });

                    if (response.ok) {
                        alert("게시물이 수정되었습니다.")
                        closeModifyPostModal(postId);
                    } else {
                        const errorText = await response.text();
                        alert(errorText);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }

            // AJAX 게시물 삭제.
            async function deletePost(postId) {
                if (!confirm("게시물을 삭제하시겠습니까?")) {
                    return;
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/post/delete/${postId}`, {
                        method: "POST",
                        headers: {
                            [header]: token
                        }
                    });

                    if (response.ok) {
                        alert("게시물이 삭제되었습니다.");
                    } else {
                        const errorMsg = await response.text();
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }

            // AJAX 댓글 등록.
            async function submitAnswer(form, event, postId) {
                event.preventDefault();

                const textarea = form.querySelector("textarea");
                const content = textarea.value;
                

                if (content.trim() === "") {
                    alert("내용을 입력해 주세요.");
                    return false;
                }

                const formData = new FormData();
                formData.append("content", content);

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/answer/create/${postId}`, {
                        method: "POST",
                        headers: { 
                            [header]: token 
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const postBox = form.closest('.post-right');
                        const answerContainer = postBox.querySelector('.answer-box');
                        textarea.value = ""; 
                        answerContainer.scrollTop = answerContainer.scrollHeight; 
                    } else {
                        console.log("Error status:", response.status);
                        alert("로그인이 되어있는지 확인해 주세요.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("시스템 오류가 발생했습니다.");
                }
                return false;
            }

            // AJAX 댓글 수정.
            function modifyAnswer(answerId) {
                const answerContentBox = document.getElementById('answer-' + answerId);
                const contentDiv = answerContentBox.children[1];
                const oldContent = contentDiv.innerText;

                if (oldContent === "삭제된 댓글입니다.") {
                alert("삭제된 댓글입니다.");
                return;
                }

                document.getElementById('modify-answer-content-' + answerId).value = oldContent;
                document.getElementById('modifyAnswer-' + answerId).style.display = 'flex';
            }

            function closeModifyAnswerModal(answerId) {
                document.getElementById('modifyAnswer-' + answerId).style.display = 'none';
            }

            async function submitModifyAnswer(answerId) {
                const contentInput = document.getElementById('modify-answer-content-' + answerId);
                const newContent = contentInput.value;

                if (newContent.trim() === "") {
                    alert("내용을 입력해 주세요.");
                    return;
                }

                const formData = new FormData();
                formData.append("newContent", newContent);
                
                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/answer/modify/${answerId}`, {
                        method: "POST",
                        headers: { [header]: token },
                        body: formData
                    });

                    if (response.ok) {
                        alert("댓글이 수정되었습니다.");
                        closeModifyAnswerModal(answerId);
                    } else {
                        const errorText = await response.text();
                        alert(errorText);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }


            // AJAX 댓글 삭제.
            async function deleteAnswer(answerId) {
                if (!confirm("댓글을 삭제하시겠습니까?")) {
                    return;
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/answer/delete/${answerId}`, {
                        method: "POST",
                        headers: {
                            [header]: token
                        }
                    });

                    if (response.ok) {
                        alert("댓글이 삭제되었습니다.");
                    } else {
                        const errorMsg = await response.text();
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }

            var socket = new SockJS('/ws-stomp-web');
            var stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('실시간 연결 성공: ' + frame);

                stompClient.subscribe('/sub/posts', function (message) {
                    var newPost = JSON.parse(message.body);
                    if (document.getElementById('post-answer-box-' + newPost.id)) {
                        updatePost(newPost);
                    } else {
                        addPost(newPost); 
                    }
                });
                stompClient.subscribe('/sub/answers', function (message) {
                    var newAnswer = JSON.parse(message.body);
                    if (document.getElementById('answer-' + newAnswer.id)) {
                        updateAnswer(newAnswer);
                    } else {
                        addAnswer(newAnswer);
                    }
                }); 
                stompClient.subscribe('/sub/user-update', function (message) {
                    var data = JSON.parse(message.body);
                    if (data.type === "WITHDRAWAL") {
                        handleForceLogout(data.id);
                    } else {
                        changeUsername(data.id, data.newUsername);
                    }
                });
            });

            function updatePost(post) {
                const container = document.getElementById('post-answer-box-' + post.id);
                if (!container) return;

                const contentBox = container.querySelector('.post-box');
                const isDeleted = post.content === "삭제된 게시물입니다.";
                let htmlContent = '';
                
                if (isDeleted) {
                    htmlContent = `<div style="white-space: pre-wrap; color: #999;">${post.content}</div>`;
                } else {
                    htmlContent = `<div style="white-space: pre-wrap;">${post.content}</div>`;
                    if (post.imgUrl) {
                        htmlContent += `<img src="${post.imgUrl}" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 30px; margin-top: 20px;">`;
                    }
                }
                contentBox.innerHTML = htmlContent;

                const dateDiv = container.querySelector('.post-header > div:last-child');
                if (dateDiv) {
                    let statusHtml = '';
                    if (post.deletedAt) {
                        statusHtml = '<span style="color: #999; font-size: 13px;"> (삭제됨)</span>';
                    } else if (post.modifiedAt) {
                        statusHtml = '<span style="color: #999; font-size: 13px;"> (수정됨)</span>';
                    }
                    const dateText = post.createDate.replace('T', ' ').substring(0, 16); 
                    dateDiv.innerHTML = `<span>${dateText}</span>${statusHtml}`;
                }
                closeModifyPostModal(post.id);
            }

            function updateAnswer(answer) {
                const answerContentBox = document.getElementById('answer-' + answer.id);
                if (!answerContentBox) return;

                const contentDiv = answerContentBox.children[1];
                if (contentDiv) {
                    contentDiv.innerText = answer.content;
                    
                    if (answer.content === "삭제된 댓글입니다.") {
                        contentDiv.style.color = "#999";
                    }
                }
                const dateDiv = answerContentBox.querySelector('.post-header > div:last-child');
                if (dateDiv) {
                    let statusHtml = '';
                    if (answer.deletedAt) {
                        statusHtml = '<span style="color: #999; font-size: 13px;"> (삭제됨)</span>';
                    } else if (answer.modifiedAt) {
                        statusHtml = '<span style="color: #999; font-size: 13px;"> (수정됨)</span>';
                    }
                    const dateText = answer.createDate.replace('T', ' ').substring(0, 16);
                    dateDiv.innerHTML = `<span>${dateText}</span>${statusHtml}`;
                }
                closeModifyAnswerModal(answer.id);
            }

            async function handleForceLogout(targetUserId) {
                const navUsername = document.getElementById('nav-username');
                if (navUsername) {
                    const myId = navUsername.getAttribute('data-user-id');
                    
                    if (myId == targetUserId) {
                        alert("회원탈퇴가 완료되어 로그아웃 처리되었습니다.");

                        const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                        const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                        const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                        const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                        try {
                            await fetch("/user/logout", {
                                method: "POST",
                                headers: {
                                    [header]: token
                                }
                            });
                        } catch (error) {
                            console.error("로그아웃 요청 실패:", error);
                        } finally {
                            window.location.replace("/user/login"); 
                        }
                    }
                }
            }

            function addPost(post) {
                if (document.getElementById('post-answer-box-' + post.id)) return;

                const navUsername = document.getElementById('nav-username');
                const myId = navUsername ? navUsername.getAttribute('data-user-id') : null;
                const isMyPost = post.author && (post.author.id == myId);
                var newPostHtml = `
                    <div class="post-answer-box" id="post-answer-box-${post.id}">
                        <div class="post-left">
                            <div class="post-header" style="margin-bottom: 10px;">
                                <div class="username-display"
                                    data-user-id="${post.author ? post.author.id : ''}"
                                    style="${post.author ? 'font-weight: bold; color: #050505;' : 'font-weight: bold; color: #999;'}">
                                    ${post.author ? post.author.username : '탈퇴한 사용자'}
                                </div>
                                <div>
                                    <div>${post.createDate.replace('T', ' ').substring(0, 16)}</div>
                                    ${post.deletedAt ? '<span style="color: #999; font-size: 12px;"> (삭제됨)</span>' : (post.modifiedAt ? '<span style="color: #999; font-size: 13px;"> (수정됨)</span>' : '')}
                                </div>
                            </div>
                            <div class="post-box">
                                <div style="${post.content === '삭제된 게시물입니다.' ? 'white-space: pre-wrap; color: #999;' : 'white-space: pre-wrap;' }">${post.content}</div>
                                ${post.imgUrl && !(post.content === '삭제된 게시물입니다.') ? `
                                <div if="${post.imgUrl != null && !(post.content === '삭제된 게시물입니다.')}" style="display: flex; justify-content: center;">
                                    <img src="${post.imgUrl}" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 30px; margin-top: 20px;">
                                </div>` : ''}
                            </div>
                            ${isMyPost ? 
                            `<div style="margin-top: auto; display: flex; justify-content: flex-end; padding-top: 10px;">
                                <button type="button"
                                        onclick="modifyPost(${post.id})"
                                        style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                                        수정</button>
                                <div class="post-vertical-line"></div>
                                <button type="button" 
                                        onclick="deletePost(${post.id})"
                                        style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">
                                    삭제
                                </button>
                            </div>` : ''}
                        </div>
                        <div class="post-right">
                            <div class="answer-box"></div>
                            <div class="horizontal-line"></div>
                            <form onsubmit="return submitAnswer(this, event, ${post.id})">
                                <div class="answer-footer">
                                    <textarea class="answer-input answer-input-box" placeholder="댓글을 작성해 주세요."></textarea>
                                    <button type="submit" class="btn-blue">게시</button>
                                </div>
                            </form>
                        </div>
                        <div id="modifyPost-${post.id}" class="modal-overlay">
                            <div class="modal-box">
                                <div class="modal-header">게시물 수정</div>
                                <textarea id="modify-content-input-${post.id}" class="modify-content-input" placeholder="내용을 입력해 주세요." >
                                </textarea>

                                <div id="modify-image-container-${post.id}" style="position: relative; display: none; margin-top: 10px;">
                                    <img id="modify-image-preview-${post.id}" src="" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 30px;">
                                    <button type="button" 
                                            onclick="removeImageInModal(${post.id})"
                                            style="position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                        X
                                    </button>
                                </div>
                                <input type="checkbox" id="delete-img-check-${post.id}" style="display: none;">

                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                    <span id="modify-filename-${post.id}" style="font-size: 13px; color: #1877f2;"></span>
                                    <input type="file" id="modify-file-${post.id}" style="display: none;" onchange="updateModifyFile(${post.id})">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn-gray" onclick="document.getElementById('modify-file-${post.id}').click()">추가</button>
                                    <div style="gap: 10px;">
                                        <button type="button" class="btn-gray" onclick="closeModifyPostModal(${post.id})">취소</button>
                                        <button type="button" class="btn-blue" onclick="submitModifyPost(${post.id})">수정 완료</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                var writeBox = document.querySelector('.write-box');
                writeBox.insertAdjacentHTML('afterend', newPostHtml);
            }

            function addAnswer(answer) {
                var postAnswerBox = document.getElementById('post-answer-box-' + answer.postId);
                if (postAnswerBox) {
                    if (document.getElementById('answer-' + answer.id)) return;

                    var answerBox = postAnswerBox.querySelector('.answer-box'); 

                    const navUsername = document.getElementById('nav-username');
                    const myId = navUsername ? navUsername.getAttribute('data-user-id') : null;
                    const isMyAnswer = answer.author && (answer.author.id == myId);

                    var newAnswerHtml = `
                        <div class="answer-content-box" id="answer-${answer.id}">
                            <div class="post-header">
                                <div class="username-display"
                                    data-user-id="${answer.author ? answer.author.id : ''}"
                                    style="${answer.author ? 'font-weight: bold; color: #050505;' : 'font-weight: bold; color: #999;'}">
                                    ${answer.author ? answer.author.username : '탈퇴한 사용자'}
                                </div>
                                <div>
                                    <div>${answer.createDate.replace('T', ' ').substring(0, 16)}</div>
                                    ${answer.deletedAt ? '<span style="color: #999; font-size: 12px;"> (삭제됨)</span>' : (answer.modifiedAt ? '<span style="color: #999; font-size: 13px;"> (수정됨)</span>' : '')}
                                </div>
                            </div>
                            <div style="white-space: pre-wrap;">${answer.content}</div>
                            ${isMyAnswer ? `
                            <div style="margin-top: auto; display: flex; justify-content: flex-end; padding-top: 10px;">
                                <button type="button" onclick="modifyAnswer(${answer.id})"
                                        style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">수정</button>
                                <div class="answer-vertical-line"></div>
                                <button type="button" onclick="deleteAnswer(${answer.id})"
                                        style="background: none; border: none; color: #65676b; font-size: 13px; cursor: pointer; padding: 0;">삭제</button>
                            </div>
                            ` : ''}

                            <div id="modifyAnswer-${answer.id}" class="modal-overlay">
                                <div class="modal-box">
                                    <div class="modal-header">댓글 수정</div>
                                    <textarea id="modify-answer-content-${answer.id}" class="modify-content-input" placeholder="내용을 입력해 주세요."></textarea>
                                    <div class="modal-footer">
                                        <div></div>
                                        <div style="gap: 10px;">
                                            <button type="button" class="btn-gray" onclick="closeModifyAnswerModal(${answer.id})">취소</button>
                                            <button type="button" class="btn-blue" onclick="submitModifyAnswer(${answer.id})">수정 완료</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    answerBox.insertAdjacentHTML('beforeend', newAnswerHtml);
                    answerBox.scrollTop = answerBox.scrollHeight;
                }
            }

            function changeUsername(userId, newUsername) {
                const targets = document.querySelectorAll(`.username-display[data-user-id='${userId}']`);
                targets.forEach(el => {
                    el.innerText = newUsername;
                });
                const navUsername = document.getElementById('nav-username');
                if (navUsername) {
                    const myId = navUsername.getAttribute('data-user-id');
                    if (myId == userId) {
                        navUsername.innerText = newUsername;
                    }
                }
            }
        </script>
    </div>
</html>
