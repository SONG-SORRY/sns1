<html layout:decorate="~{mainpage_layout}">
    <div layout:fragment="content" class="container">
        <div class="write-box">
            <form th:action="@{/}" method="post" th:object="${postForm}">
                <textarea class="write-input-box"th:field="*{content}" placeholder="무슨 생각을 하고 계신가요?"></textarea>
                <div class="horizontal-line"></div>
                <div class="write-footer">
                    <button type="button" class="btn-gray">추가</button>
                    <button type="submit" class="btn-blue">게시</button>
                </div>
            </form>
        </div>

        <div class="post-box" th:each="post : ${postList}">

            <div class="post-left">
                <div class="post-header">
                    <div th:if="${post.author != null}" th:text="${post.author.username}" style="font-weight: bold; color: #050505;"></div>
                    <div th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                </div>   
                <div class="post-content" th:text="${post.content}"></div>
            </div>

            <div class="post-right">
                <div class="post-answer-footer">
                    <div class="post-answer-footer-content-box" th:each="answer : ${post.answerList}">
                        <div class="post-header">
                            <div th:if="${answer.author != null}" th:text="${answer.author.username}" style="font-weight: bold; color: #050505;"></div> 
                            <div th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                        <div th:text="${answer.content}"></div>
                    </div>
                </div>

                <div class="horizontal-line" th:if="${!post.answerList.isEmpty()}"></div>
                <form th:onsubmit="'return submitAnswer(this, event, ' + ${post.id} + ')'">
                    <div class="post-footer">
                        <textarea name="content" class="answer-input-box answer-box" placeholder="댓글을 작성해 주세요."></textarea>
                        <button type="submit" class="btn-blue">게시</button>
                    </div>
                </form>
            </div>
            <div th:if="${postList.isEmpty()}" style="text-align: center; color: #888; padding: 20px;">
                    <p>등록된 게시물이 없습니다.</p>
            </div>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const answerBoxes = document.querySelectorAll('.post-answer-footer');
                answerBoxes.forEach(function(box) {
                    box.scrollTop = box.scrollHeight;
                });
            });
        </script>
        <script>
            async function submitAnswer(form, event, postId) {
                event.preventDefault();

                const textarea = form.querySelector("textarea");
                const content = textarea.value;

                if (content.trim() === "") {
                    alert("내용을 입력해주세요.");
                    return false;
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');

                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/api/answer/create/${postId}`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/x-www-form-urlencoded",
                            [header]: token 
                        },
                        body: `content=${encodeURIComponent(content)}`
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === "success") {
                            const postBox = form.closest('.post-right');
                            const answerContainer = postBox.querySelector('.post-answer-footer');

                            const newAnswerHtml = `
                                <div class="post-answer-footer-content-box">
                                    <div class="post-header">
                                        <div style="font-weight: bold; color: #050505;">${data.username}</div> 
                                        <div>${data.createDate}</div>
                                    </div>
                                    <div>${data.content}</div>
                                </div>
                            `;
                            answerContainer.insertAdjacentHTML('beforeend', newAnswerHtml);
                            textarea.value = ""; 
                            answerContainer.scrollTop = answerContainer.scrollHeight; 
                        }
                    } else {
                        console.log("Error status:", response.status);
                        alert("등록 실패: 로그인이 되어있는지 확인해주세요.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("시스템 오류가 발생했습니다.");
                }
                return false;
            }
        </script>
        <script>
            document.addEventListener("input", function(e) {
                if (e.target.tagName.toLowerCase() === "textarea" && e.target.classList.contains("answer-input-box")) {
                    
                    const form = e.target.closest('form');
                    const postBox = form.closest('.post-right');
                    const answerContainer = postBox.querySelector('.post-answer-footer');

                    const isAtBottom = answerContainer.scrollHeight - answerContainer.scrollTop - answerContainer.clientHeight < 50;

                    if (isAtBottom) {
                        answerContainer.scrollTop = answerContainer.scrollHeight;
                    }
                }
            });
        </script>
    </div>
</html>
