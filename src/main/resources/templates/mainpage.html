<html layout:decorate="~{mainpage_layout}">
    <div layout:fragment="content" class="container">
        <div class="write-box">
            <form onsubmit="return submitPost(event)">
                <textarea id="write-input" class="write-input" placeholder="무슨 생각을 하고 계신가요?"></textarea>
                <input type="file" id="file" name="file" style="display: none;" onchange="updateFileName()">
                <div id="fileNameDisplay" style="font-size: 12px; color: #1877f2; margin-bottom: 5px;"></div>
                <div class="horizontal-line"></div>
                
                <div class="write-footer">
                    <button type="button" class="btn-gray" onclick="document.getElementById('file').click()">추가</button>
                    <button type="submit" class="btn-blue">게시</button>
                </div>
            </form>
        </div>

        <div class="post-answer-box" th:each="post : ${postList}" th:id="'postbox-' + ${post.id}">
            <div class="post-left">
                <div class="post-header">
                    <div th:if="${post.author != null}" 
                        th:text="${post.author.username}" 
                        style="font-weight: bold; color: #050505;">
                    </div>
                    <div th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}">
                    </div>
                </div> 
                <div class="post-box">
                    <div th:text="${post.content}" style="white-space: pre-wrap;"></div>
                    <div th:if="${post.imgUrl != null}" style="margin-top: 20px;">
                        <img th:src="${post.imgUrl}" style="max-width: 100%; border-radius: 20px;">
                    </div>
                </div>
            </div>

            <div class="post-right">
                <div class="answer-box">
                    <div class="answer-content-box" th:each="answer : ${post.answerList}" th:id="'answer-' + ${answer.id}">
                        <div class="post-header">
                            <div th:if="${answer.author != null}" th:text="${answer.author.username}" style="font-weight: bold; color: #050505;"></div> 
                            <div th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                        <div th:text="${answer.content}" style="white-space: pre-wrap;"></div>
                    </div>
                </div>

                <div class="horizontal-line" th:if="${!post.answerList.isEmpty()}"></div>
                <form th:onsubmit="'return submitAnswer(this, event, ' + ${post.id} + ')'">
                    <div class="answer-footer">
                        <textarea class="answer-input-box answer-input" placeholder="댓글을 작성해 주세요."></textarea>
                        <button type="submit" class="btn-blue">게시</button>
                    </div>
                </form>
            </div>
            <div th:if="${postList.isEmpty()}" style="text-align: center; color: #888; padding: 20px;">
                <p>등록된 게시물이 없습니다.</p>
            </div>
        </div>
        <script> // 게시물 댓글 스크롤을 최하단으로 이동.
            document.addEventListener("DOMContentLoaded", function() {
                const answerBoxes = document.querySelectorAll('.answer-box');
                answerBoxes.forEach(function(box) {
                    box.scrollTop = box.scrollHeight;
                });
            });
        </script>
        <script> // AJAX 댓글 등록.
            async function submitAnswer(form, event, postId) {
                event.preventDefault();

                const textarea = form.querySelector("textarea");
                const content = textarea.value;
                

                if (content.trim() === "") {
                    alert("내용을 입력해주세요.");
                    return false;
                }

                const formData = new FormData();
                formData.append("content", content);

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch(`/answer/create/${postId}`, {
                        method: "POST",
                        headers: { 
                            [header]: token 
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                            const postBox = form.closest('.post-right');
                            const answerContainer = postBox.querySelector('.answer-box');
                            textarea.value = ""; 
                            answerContainer.scrollTop = answerContainer.scrollHeight; 
                    } else {
                        console.log("Error status:", response.status);
                        alert("등록 실패: 로그인이 되어있는지 확인해주세요.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("시스템 오류가 발생했습니다.");
                }
                return false;
            }
        </script>
        <script> // 댓글 입력 중 댓글 입력창 높이에 의한 댓글창 가림 해결.
            document.addEventListener("input", function(e) {
                if (e.target.tagName.toLowerCase() === "textarea" && e.target.classList.contains("answer-input")) {
                    
                    const textarea = e.target;
                    const form = textarea.closest('form');
                    const postBox = form.closest('.post-right');
                    const answerContainer = postBox.querySelector('.answer-box');

                    if (!textarea.dataset.prevHeight) {
                        textarea.dataset.prevHeight = textarea.clientHeight;
                    }

                    const isAtBottom = answerContainer.scrollHeight - answerContainer.scrollTop - answerContainer.clientHeight < 10;

                    const currentHeight = textarea.clientHeight;
                    const prevHeight = parseFloat(textarea.dataset.prevHeight);
                    const diff = currentHeight - prevHeight;

                    if (isAtBottom) {
                        answerContainer.scrollTop = answerContainer.scrollHeight;
                    } else {
                        if (diff !== 0) {
                            answerContainer.scrollTop += diff;
                        }
                    }

                    textarea.dataset.prevHeight = currentHeight;
                        }
                    });

                    document.addEventListener("focusin", function(e) {
                        if (e.target.tagName.toLowerCase() === "textarea" && e.target.classList.contains("answer-input")) {
                            e.target.dataset.prevHeight = e.target.clientHeight;
                        }
                    });
        </script>
        <script>
            // 선택된 파일명을 화면에 보여주는 기능.
            function updateFileName() {
                const fileInput = document.getElementById('file');
                const fileNameDisplay = document.getElementById('fileNameDisplay');
                
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                } else {
                    fileNameDisplay.textContent = "";
                }
            }

            // AJAX 게시물 등록.
            async function submitPost(event) {
                event.preventDefault(); 


                const contentInput = document.getElementById('write-input');
                const fileInput = document.getElementById('file');
                

                const content = contentInput.value;
                const file = fileInput.files[0];

                if (content.trim() === "" && !file) {
                    alert("내용을 입력해 주세요.");
                    return false;
                }

                const formData = new FormData();
                formData.append("content", content);
                if (file) {
                    formData.append("file", file);
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch("/post/create", { 
                        method: "POST",
                        headers: {
                            [header]: token 
                        },
                        body: formData
                    });

                    if (response.ok) {
                        contentInput.value = "";
                        fileInput.value = "";
                        document.getElementById('fileNameDisplay').textContent = "";
                    } else {
                        const data = await response.json();
                        alert(data.message);
                    }
                } catch (error) {
                    console.error(error);
                    alert("에러 발생");
                }
                return false;
            }
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

        <script>
            var socket = new SockJS('/ws-stomp-web');
            var stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('실시간 연결 성공: ' + frame);

                stompClient.subscribe('/sub/posts', function (message) {
                    var newPost = JSON.parse(message.body);
                    addPost(newPost); 
                });
                stompClient.subscribe('/sub/answers', function (message) {
                    var newAnswer = JSON.parse(message.body);
                    addAnswer(newAnswer);
                });
            });

            function addPost(post) {
                var newPostHtml = `
                    <div class="post-answer-box" id="postbox-${post.id}">
                        <div class="post-left">
                            <div class="post-header" style="margin-bottom: 10px;">
                                <div style="font-weight: bold; color: #050505;">${post.author ? post.author.username : '알 수 없음'}</div>
                                <div>${post.createDate}</div>
                            </div>
                            <div class="post-box">
                                <div style="white-space: pre-wrap;">${post.content}</div>
                                ${post.imgUrl ? `<div style="margin-top: 20px;"><img src="${post.imgUrl}" style="max-width: 100%; border-radius: 10px;"></div>` : ''}
                            </div>
                        </div>
                        <div class="post-right">
                            <div class="answer-box"></div>
                            <div class="horizontal-line"></div>
                            <form onsubmit="return submitAnswer(this, event, ${post.id})">
                                <div class="answer-footer">
                                    <textarea class="answer-input answer-input-box" placeholder="댓글을 작성해 주세요."></textarea>
                                    <button type="submit" class="btn-blue">게시</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                var writeBox = document.querySelector('.write-box');
                writeBox.insertAdjacentHTML('afterend', newPostHtml);
            }

            function addAnswer(answer) {
                var postBox = document.getElementById('postbox-' + answer.postId);
                
                if (postBox) {
                    if (document.getElementById('answer-' + answer.id)) {
                    return; 
                }
                    var answerContainer = postBox.querySelector('.answer-box'); 
                    var newAnswerHtml = `
                        <div class="answer-content-box" id="answer-${answer.id}">
                            <div class="post-header">
                                <div style="font-weight: bold; color: #050505;">${answer.author ? answer.author.username : answer.username}</div> 
                                <div>${answer.createDate}</div>
                            </div>
                            <div style="white-space: pre-wrap;">${answer.content}</div>
                        </div>
                    `;
                    answerContainer.insertAdjacentHTML('beforeend', newAnswerHtml);
                    answerContainer.scrollTop = answerContainer.scrollHeight;
                }
            }
        </script>
    </div>
</html>
