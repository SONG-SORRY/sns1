<html layout:decorate="~{mainpage_layout}">
    <div layout:fragment="content" class="container">
        <div class="detail-box">
            <div style="text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 30px;">내 정보</div>
            <div style="text-align: center;">

                <div class="label">이메일</div>
                <div class="box" th:text="${userData.email}"></div>

                <div class="label">사용자명</div>
                <div class="box" id="username" th:text="${userData.username}"></div>

                <div class="label">사용자명 변경</div>
                <input type="text" name="newUsername" id="newUsername" th:value="${userData.username}"></input>
                <button type="button" onclick="updateUsername()" class="btn-submit" style="margin-bottom: 10px;">변경</button>

                <div class="label">비밀번호 변경</div>
                <div>
                    <input type="password" name="currentPassword" id="currentPassword" placeholder="현재 비밀번호">
                    <input type="password" name="newPassword1" id="newPassword1" placeholder="새 비밀번호">
                    <input type="password" name="newPassword2" id="newPassword2" placeholder="새 비밀번호 (확인)">
                    <button type="button" onclick="updatePassword()" class="btn-submit" style="margin-bottom: 10px;">변경</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <form th:action="@{/user/logout}" method="post" style="display:inline;">
                        <button type="submit" class="nav-item" 
                        style="background:none; border:none; padding:0; cursor:pointer; font-weight: bold; color:inherit;">로그아웃</button>
                    </form>
                </div>
                <div>
                    <button type="button" onclick="withdrawal()" class="nav-item" 
                    style="background:none; border:none; padding:0; cursor:pointer; font-weight: bold; color:inherit;">회원탈퇴</button>
                </div>
            </div>
        </div>

        <style>
            .container {
                display: flex;
                justify-content: center;
                align-items: center;
                height: calc(100vh - 100px);
            }
            .detail-box {
                box-sizing: border-box;
                background: rgba(255, 255, 255, 0.3); 
                padding: 20px;
                width: 500px; 
                border-radius: 30px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
                text-align: center; 
            }
            input { 
                width: 100%;
                padding: 12px;
                margin-bottom: 12px;
                border: 1px solid #ddd;
                border-radius: 20px;
                box-sizing: border-box;
                outline: none;
                font-size: 18px;
            }
            .box { 
                width: 100%;
                padding: 8px 15px;
                margin-bottom: 12px;
                border: 1px solid #ddd;
                border-radius: 20px;
                box-sizing: border-box;
                text-align: left; 
                font-size: 18px;
                color: #050505;
            }
            .label {
                text-align: left;
                font-size: 14px;
                color: #050505;
                margin-bottom: 5px;
                margin-left: 5px;
            }
            .btn-submit { 
                width: 100%; 
                padding: 12px; 
                background-color: #1877f2; 
                color: white; 
                border: none; 
                border-radius: 20px; 
                font-weight: bold; 
                cursor: pointer; 
                font-size: 15px; 
            }
        </style>

        <script>
            async function updateUsername() {
                const newUsername = document.getElementById("newUsername").value;
                if (!newUsername.trim()) {
                    alert("변경할 이름을 입력해 주세요.");
                    return;
                }

                const formData = new FormData();
                formData.append("newUsername", newUsername);

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch("/user/changeUsername", {
                        method: "POST",
                        headers: { [header]: token },
                        body: formData
                    });
                    
                    const data = await response.json();

                    if (data.status === "success") {
                        alert(data.message);
                        document.getElementById("username").innerText = data.newUsername;
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }

            async function updatePassword() {
                const currentPassword = document.getElementById("currentPassword").value;
                const newPassword1 = document.getElementById("newPassword1").value;
                const newPassword2 = document.getElementById("newPassword2").value;

                if (!currentPassword || !newPassword1 || !newPassword2) {
                    alert("모든 비밀번호를 입력해 주세요.");
                    return;
                }
                if (newPassword1 !== newPassword2) {
                    alert("새 비밀번호가 일치하지 않습니다.");
                    return;
                }

                const formData = new FormData();
                formData.append("currentPassword", currentPassword);
                formData.append("newPassword1", newPassword1);
                formData.append("newPassword2", newPassword2);

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                try {
                    const response = await fetch("/user/changePassword", {
                        method: "POST",
                        headers: { [header]: token },
                        body: formData
                    });

                    const data = await response.json();

                    if (data.status === "success") {
                        alert(data.message);
                        window.location.replace("/user/login"); 
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    console.error(error);
                    alert("오류가 발생했습니다.");
                }
            }

            async function withdrawal() {
                if (!confirm("회원탈퇴를 계속 진행하시겠습니까?\n탈퇴 시 모든 데이터가 삭제되며 복구할 수 없습니다.")) {
                    return;
                }
                const password = prompt("본인 확인을 위해 비밀번호를 입력해 주세요.");
                if (!password) {
                    alert("비밀번호를 입력해 주세요.");
                    return;
                }

                const csrfTokenNode = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderNode = document.querySelector('meta[name="_csrf_header"]');
                const token = csrfTokenNode ? csrfTokenNode.getAttribute("content") : "";
                const header = csrfHeaderNode ? csrfHeaderNode.getAttribute("content") : "";

                const formData = new FormData();
                formData.append("password", password);

                try {
                    const response = await fetch("/user/withdrawal", {
                        method: "POST",
                        headers: {
                            [header]: token 
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (data.status === "success") {
                        alert(data.message);
                        window.location.replace("/user/login");
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("서버 오류가 발생했습니다.");
                }
            }
        </script>
    </div>
</html>